#!/bin/bash
set -e

usage() {
	echo "usage: mmail enable|disable FEATURE"
	echo "see man mmail(1)"
}

# files
maincf="/etc/postfix/main.cf"
contfilt="/etc/postfix/mmail/mmail.contfilt.regexp"

# check parameters
if [ $# -ne 2 ]
then
	echo "error: invalid parameter count"
	usage
	exit 1
fi
case "$1" in
enable) ;;
disable) ;;
*)
	echo "error: invalid 1st parameter"
	usage
	exit 1
esac

# check privileges
if [ $(id -u) -ne 0 ]
then
	echo "Run this script with root privileges!"
	exit 1
fi

# check system
sctl=$(which systemctl)

# stop postfix
if [ -n "$sctl" ]
then
	systemctl stop postfix
else	
	/etc/init.d/postfix stop
fi

case "$2" in
amavis-vt)
	systemctl stop amavisd-new
	case "$1" in
	enable) 
		if test -f /etc/amavis/conf.d/56-mmail_scanners.no
		then 
			mv /etc/amavis/conf.d/55-mmail_filter_mode.no /etc/amavis/conf.d/55-mmail_filter_mode
			mv /etc/amavis/conf.d/56-mmail_scanners.no /etc/amavis/conf.d/56-mmail_scanners
		fi
		;;
	disable)
		if test -f /etc/amavis/conf.d/56-mmail_scanners
		then 
			mv /etc/amavis/conf.d/55-mmail_filter_mode /etc/amavis/conf.d/55-mmail_filter_mode.no
			mv /etc/amavis/conf.d/56-mmail_scanners /etc/amavis/conf.d/56-mmail_scanners.no
		fi
		;;
	esac
	systemctl start amavisd-new
	;;
e2e-in)
	commenter.pl $contfilt EEI $1
	case "$1" in
	enable) 
		/etc/init.d/decryptd start
		update-rc.d decryptd defaults 100
		;;
	disable)
		/etc/init.d/decryptd stop
		update-rc.d -f decryptd remove
		;;
	esac
	;;
mlist)
	case "$1" in
	enable)
		echo "Installing mlist feature"
		if [ -n "$(postconf -h smtpd_recipient_restrictions |grep mlist.contfilt.regexp)" ]
		then
			echo "mlist already installed"
		else
			postconf smtpd_recipient_restrictions="check_recipient_access regexp:/etc/postfix/mmail/mlist.contfilt.regexp $(postconf -h smtpd_recipient_restrictions)"
		fi
		/etc/init.d/mlistd start
		update-rc.d mlistd defaults 100
		;;
	disable)
		echo "Deinstalling mlist feature"
		restr=$(postconf -hf smtpd_recipient_restrictions |grep -v mlist.contfilt.regexp)
		postconf smtpd_recipient_restrictions="$restr"
		/etc/init.d/mlistd stop
		update-rc.d -f mlistd remove
		;;
	esac
	;;
tls-out)
	commenter.pl $maincf TO $1
	case "$1" in
	enable)
		if test "$(postmulti -l -i postfix-smtp-tls |wc -l) -eq 1"
		then
			postmulti -e enable -i postfix-smtp-tls
		else
			postmulti -e create -I postfix-smtp-tls config_directory=/etc/postfix/smtp-tls
		fi
		;;
	disable)
		postmulti -e disable -i postfix-smtp-tls
		postmulti -e deport -i postfix-smtp-tls
		;;
	esac

	;;
*)
	echo "error: invalid FEATURE"
	usage
	exit 1
esac

# start postfix
if [ -n "$sctl" ]
then
	systemctl start postfix || true
else	
	/etc/init.d/postfix start || true
fi


